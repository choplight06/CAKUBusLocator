<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CAKU Bus Finder</title>
  <style>
    :root {
      --bg: #0b1020;
      --surface: #0f172a;
      --panel: #111a2e;
      --panel-2: #0e1528;
      --fg: #e6eefc;
      --muted: #9fb0d0;
      --border: #1e2a47;
      --accent: #6ea8fe;
      --accent-2: #60a5fa;
      --ok-bg: #143126;
      --ok-br: #2b6b47;
      --no-bg: #351821;
      --no-br: #7a2c40;
      --shadow: 0 4px 24px rgba(0,0,0,.35);
      --radius: 16px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color-scheme: dark;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f6f8ff;
        --surface: #ffffff;
        --panel: #ffffff;
        --panel-2: #f9fbff;
        --fg: #111827;
        --muted: #64748b;
        --border: #e5e7eb;
        --accent: #2563eb;
        --accent-2: #1d4ed8;
        --ok-bg: #eaf8ef;
        --ok-br: #bfe8cc;
        --no-bg: #fbeeee;
        --no-br: #f3c0c0;
        --shadow: 0 6px 24px rgba(0,0,0,.08);
      }
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 800px at 10% -10%, rgba(96,165,250,.2), transparent 45%),
                  radial-gradient(1200px 800px at 100% 0%, rgba(99,102,241,.18), transparent 40%),
                  var(--bg);
      color: var(--fg);
    }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px clamp(12px, 3vw, 28px) 40px; }
    .hero {
      border-radius: 24px; padding: clamp(16px, 3.5vw, 28px); margin: 16px 0 22px;
      background: linear-gradient(135deg, rgba(37,99,235,.14), rgba(99,102,241,.08)), var(--panel);
      box-shadow: var(--shadow); border: 1px solid var(--border);
    }
    .hero h1 { margin: 0 0 4px; font-weight: 800; letter-spacing: -.02em; font-size: clamp(1.4rem, 3.4vw, 2rem); }
    .hero p { margin: 0; color: var(--muted); font-size: clamp(.95rem, 2.2vw, 1.05rem); }
    .card { border: 1px solid var(--border); border-radius: var(--radius);
      padding: clamp(12px, 2vw, 18px); background: linear-gradient(180deg, var(--panel), var(--panel-2));
      box-shadow: var(--shadow); margin-bottom: 16px; }
    .sticky { position: sticky; top: 10px; z-index: 50; backdrop-filter: saturate(120%) blur(6px); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 740px) { .row { grid-template-columns: 1fr; } }
    label { font-size: .9rem; color: var(--muted); margin-bottom: 6px; display: block; }
    select, button {
      width: 100%; border-radius: 12px; border: 1px solid var(--border); padding: 14px 14px; font-size: 1rem;
      background: var(--surface); color: var(--fg); -webkit-tap-highlight-color: transparent;
      transition: box-shadow .15s ease, transform .06s ease, border-color .15s ease;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02), 0 1px 0 rgba(0,0,0,.04);
    }
    select:focus, button:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 35%, transparent); }
    button { border-color: var(--accent); background: linear-gradient(180deg, var(--accent), var(--accent-2)); color: white; font-weight: 700; letter-spacing: .2px; }
    button:hover { transform: translateY(-1px); } button:active { transform: translateY(0); } button:disabled { opacity: .6; cursor: not-allowed; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; align-items: end; }
    @media (max-width: 740px) { .grid-3 { grid-template-columns: 1fr; } }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: .8rem; border: 1px solid var(--border); background: var(--surface); }
    .ok { background: var(--ok-bg); border-color: var(--ok-br); } .no { background: var(--no-bg); border-color: var(--no-br); }
    .muted { color: var(--muted); } .sub { font-size: .95rem; color: var(--muted); }
    table { width: 100%; border-collapse: collapse; } th, td { border-top: 1px solid var(--border); padding: 10px; text-align: left; vertical-align: top; }
    thead th { position: sticky; top: 0; background: var(--panel-2); }
    .scroll-x { overflow-x: auto; }
    @media (max-width: 740px) {
      .table-as-cards table, .table-as-cards thead, .table-as-cards tbody, .table-as-cards th, .table-as-cards td, .table-as-cards tr { display: block; width: 100%; }
      .table-as-cards thead { display: none; }
      .table-as-cards tr { border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin-bottom: 10px; background: var(--surface); }
      .table-as-cards td { border: 0; padding: 6px 0; }
      .table-as-cards td::before { content: attr(data-label); font-weight: 700; display: block; color: var(--muted); margin-bottom: 2px; }
    }
    footer { margin-top: 28px; padding-top: 14px; border-top: 1px solid var(--border); color: var(--muted); text-align: center; font-size: .95rem; }
    details.debug { margin-top: 10px; }
    details.debug summary { cursor: pointer; font-weight: 600; color: var(--accent); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .9rem; }
  </style>
</head>
<body>
  <div class="container">
    <div class="hero">
      <h1>Find Your Next Bus in Camp Arifjan, Kuwait!</h1>
      <p>Pick your current stop and destination. We’ll show the best direct ride (and a transfer if needed).</p>
    </div>

    <div id="queryCard" class="card sticky">
      <div class="row">
        <div>
          <label for="origin">You're at</label>
          <select id="origin" aria-label="Select origin stop"></select>
        </div>
        <div>
          <label for="destination">You're going to</label>
          <select id="destination" aria-label="Select destination stop"></select>
        </div>
      </div>
      <div style="margin-top:12px" class="grid-3">
        <div>
          <label>Current time (local)</label>
          <div id="now" class="sub"></div>
        </div>
        <div>
          <label for="routeFilter">Route filter (optional)</label>
          <select id="routeFilter" aria-label="Filter by route"></select>
        </div>
        <div>
          <button id="findBtn" disabled>Find buses</button>
        </div>
      </div>
    </div>

    <div id="results"></div>

    <footer>© 2025 Chloe Hoplight</footer>
  </div>

<script>
const STATE = { data: null, stops: [], routes: [] };
const ACRONYMS = ["BLDG","DFAC","MP","HHC","TMC","PBO","AWRDS","CFCC","ECP"];

function canonStop(raw){
  if (!raw) return raw;
  let s = String(raw).trim();
  const low = s.toLowerCase().replace(/\s+/g,' ').trim();
  const map = new Map([
    ["class vii yard","Class VII"],
    ["class vii","Class VII"],
    ["wash rack","Washrack"],
    ["washrack","Washrack"],
    ["zone 6 dfac","DFAC 6"],
    ["zone 6 dfac, dfac 6","DFAC 6"],
    ["dfac 6","DFAC 6"],
    ["paint shop","Paint Shop"],
    ["paintshop","Paint Shop"],
    ["zone 2 dfac","DFAC 2"],
    ["dfac 2","DFAC 2"],
  ]);
  if (map.has(low)) return map.get(low);
  const m1 = low.match(/^zone\s+(\d+)\s+dfac$/);
  if (m1) return `DFAC ${m1[1]}`;
  const m2 = low.match(/^dfac\s*([0-9]+)$/);
  if (m2) return `DFAC ${m2[1]}`;
  const tokens = s.split(/\s+/).map(t => {
    const upper = t.toUpperCase();
    if (ACRONYMS.includes(upper)) return upper;
    if (upper==="VII") return "VII";
    return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase();
  });
  let canon = tokens.join(" ");
  if (canon.toUpperCase()==="WASHRACK") canon = "Washrack";
  if (canon.toUpperCase()==="CLASS VII") canon = "Class VII";
  return canon;
}

function pad(n){ return String(n).padStart(2,'0'); }
function toMinutes(hhmm){ const [h,m] = hhmm.split(':').map(x=>parseInt(x,10)); return h*60+m; }
function fmtETA(minDiff){
  if (minDiff < 0) return "departed";
  const h = Math.floor(minDiff/60); const m = minDiff%60;
  return h===0 ? `${m} min` : `${h} hr ${m} min`;
}
function localNowHHMM(){ const d = new Date(); return pad(d.getHours())+":"+pad(d.getMinutes()); }
function projectAfter(baseMin, clockHHMM){
  let t = toMinutes(clockHHMM); while (t < baseMin) t += 1440; return t;
}

function uniqueStops(data){
  const set = new Set();
  data.routes.forEach(r => r.stops.forEach(st => set.add(canonStop(st))));
  return Array.from(set).sort((a,b)=>a.localeCompare(b));
}
function populateSelectors(){
  const origin = document.getElementById('origin');
  const destination = document.getElementById('destination');
  const routeFilter = document.getElementById('routeFilter');
  const stops = STATE.stops;
  origin.innerHTML = `<option value="">Select stop…</option>` + stops.map(s=>`<option>${s}</option>`).join('');
  destination.innerHTML = `<option value="">Select stop…</option>` + stops.map(s=>`<option>${s}</option>`).join('');
  const routes = STATE.data.routes.map(r=>r.route_name);
  routeFilter.innerHTML = `<option value="">All routes</option>` + routes.map(r=>`<option>${r}</option>`).join('');
}

function mapRunTimesByStop(run){
  const m = new Map();
  run.times.forEach(t => m.set(canonStop(t.stop), t.time));
  return m;
}

function findDirectRuns(origin, dest, routeNameOpt){
  const nowMin = toMinutes(localNowHHMM());
  const all = [];
  const debug = [];
  STATE.data.routes.forEach(route => {
    if (routeNameOpt && route.route_name !== routeNameOpt) return;
    const stopsCanon = route.stops.map(canonStop);
    if (!stopsCanon.includes(origin) || !stopsCanon.includes(dest)) {
      debug.push({route: route.route_name, reason: "route_missing_one_of_stops"});
      return;
    }
    route.runs.forEach(run => {
      const timeMap = mapRunTimesByStop(run);
      const tO = timeMap.get(origin);
      const tD = timeMap.get(dest);
      if (!tO || !tD) {
        all.push({route: route.route_name, run: run.bus_id, dep: tO||null, arr: tD||null, valid:false, reason: "missing_time_for_stop"});
        return;
      }
      let depMin = projectAfter(nowMin, tO);
      let arrMin = projectAfter(depMin, tD);
      if (arrMin <= depMin) arrMin += 1440;
      const valid = arrMin > depMin;
      all.push({ route: route.route_name, run: run.bus_id, dep: tO, arr: tD, depMin, arrMin, valid });
    });
  });
  const candidates = all.filter(x=>x.valid);
  candidates.sort((a,b)=> a.arrMin - b.arrMin || a.depMin - b.depMin);
  const recommended = candidates[0] || null;
  const others = all
    .filter(x=>x.dep && ( !recommended || x.run !== recommended.run || x.route !== recommended.route))
    .sort((a,b)=> (a.depMin || 1e9) - (b.depMin || 1e9));
  return {recommended, others, nowMin, all, debug};
}

function findBestTransfer(origin, dest){
  const nowMin = toMinutes(localNowHHMM());
  let best = null;
  const routeIdx = STATE.data.routes.map(r => ({
    route: r,
    stopsCanon: r.stops.map(canonStop),
  }));
  const allStops = new Set();
  routeIdx.forEach(({stopsCanon}) => stopsCanon.forEach(s => allStops.add(s)));
  const stopsList = Array.from(allStops).filter(s => s !== origin && s !== dest);

  function bestLeg(originStop, endStop, notBeforeMin){
    let bestLeg = null;
    routeIdx.forEach(({route, stopsCanon})=>{
      if (!stopsCanon.includes(originStop) || !stopsCanon.includes(endStop)) return;
      route.runs.forEach(run => {
        const times = mapRunTimesByStop(run);
        const tO = times.get(originStop);
        const tE = times.get(endStop);
        if (!tO || !tE) return;
        let depMin = projectAfter(notBeforeMin, tO);
        let arrMin = projectAfter(depMin, tE);
        if (arrMin <= depMin) arrMin += 1440;
        const leg = { route: route.route_name, run: run.bus_id, dep: tO, arr: tE, depMin, arrMin };
        if (!bestLeg || leg.arrMin < bestLeg.arrMin || (leg.arrMin === bestLeg.arrMin && leg.depMin < bestLeg.depMin)){
          bestLeg = leg;
        }
      });
    });
    return bestLeg;
  }

  for (const via of stopsList){
    const leg1 = bestLeg(origin, via, nowMin);
    if (!leg1) continue;
    const leg2 = bestLeg(via, dest, leg1.arrMin);
    if (!leg2) continue;
    const totalArrMin = leg2.arrMin;
    if (!best || totalArrMin < best.totalArrMin){
      best = { via, leg1, leg2, totalArrMin };
    }
  }
  return best;
}

function renderDirect(origin, dest, routeOpt){
  const {recommended, others, nowMin, all, debug} = findDirectRuns(origin, dest, routeOpt);
  const container = document.getElementById('results');
  container.innerHTML = '';

  if (!recommended){
    const transfer = findBestTransfer(origin, dest);
    if (!transfer){
      container.innerHTML = `<div class="card"><h3>No direct routes found</h3>
        <div class="muted">There are also no single-transfer options at this time.</div>
        ${renderDebug(all, debug, origin, dest)}
      </div>`;
      return;
    }
    const totalETA = fmtETA(transfer.totalArrMin - nowMin);
    const leg1Wait = fmtETA(transfer.leg1.depMin - nowMin);
    const leg2Wait = fmtETA(transfer.leg2.depMin - transfer.leg1.arrMin);
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h3>No direct routes available</h3>
      <div>However, you can <b>opt for a transfer</b> at <b>${transfer.via}</b>:</div>
      <ol>
        <li>Leg 1 — <span class="pill">${transfer.leg1.route}</span> <span class="pill">${transfer.leg1.run}</span><br/>
          Depart <b>${origin}</b> at <b>${transfer.leg1.dep}</b> (in ${leg1Wait}), arrive <b>${transfer.via}</b> at <b>${transfer.leg1.arr}</b>.
        </li>
        <li>Transfer wait at <b>${transfer.via}</b>: ${leg2Wait}</li>
        <li>Leg 2 — <span class="pill">${transfer.leg2.route}</span> <span class="pill">${transfer.leg2.run}</span><br/>
          Depart <b>${transfer.via}</b> at <b>${transfer.leg2.dep}</b>, arrive <b>${dest}</b> at <b>${transfer.leg2.arr}</b> (ETA ${totalETA}).
        </li>
      </ol>
      ${renderDebug(all, debug, origin, dest)}
    `;
    container.appendChild(card);
    return;
  }

  const earlierArrival = others.filter(o => o.valid && typeof o.arrMin==='number' && o.arrMin < recommended.arrMin);

  const rec = document.createElement('div');
  rec.className = 'card';
  const depIn = fmtETA(recommended.depMin - nowMin);
  const arrIn = fmtETA(recommended.arrMin - nowMin);
  rec.innerHTML = `
    <h3>Next bus to get you there</h3>
    <div><span class="pill">${recommended.route}</span> <span class="pill">${recommended.run}</span></div>
    <div class="sub" style="margin-top:8px">
      Departs <b>${origin}</b> at <b>${recommended.dep}</b> (in ${depIn}), arrives <b>${dest}</b> at <b>${recommended.arr}</b> (ETA ${arrIn}).
      ${recommended.arrMin >= 1440 ? `<div class="sub muted">* arrives after midnight</div>` : ''}
    </div>
    ${earlierArrival.length ? `<div class="note" style="margin-top:6px">Note: a later bus will arrive earlier than this one. See list below.</div>` : ''}
    ${renderDebug(all, debug, origin, dest)}
  `;
  container.appendChild(rec);

  const tblCard = document.createElement('div');
  tblCard.className = 'card scroll-x table-as-cards';
  tblCard.innerHTML = `<h3>Other upcoming buses from ${origin}</h3>`;
  const table = document.createElement('table');
  table.innerHTML = `
    <thead>
      <tr><th>Route / Run</th><th>Departs</th><th>Arrives at ${dest}</th><th>Status</th><th>Notes</th></tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector('tbody');

  others.forEach(o => {
    const willReach = o.valid;
    const etaDep = fmtETA((o.depMin ?? 1e9) - nowMin);
    const etaArr = willReach ? fmtETA((o.arrMin ?? 1e9) - nowMin) : '—';
    const status = willReach ? `<span class="pill ok">will reach your destination</span>` : `<span class="pill no">will not</span>`;
    const note = (willReach && o.arrMin < recommended.arrMin) ? `this bus will also take you to your destination` : '';
    const arrAfterMidnight = willReach && o.arrMin >= 1440 ? `<div class="sub muted">* arrives after midnight</div>` : '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td data-label="Route / Run"><div><b>${o.route}</b></div><div class="sub">${o.run}</div></td>
      <td data-label="Departs">${o.dep} <div class="sub muted">(${etaDep})</div></td>
      <td data-label="Arrives">${willReach ? o.arr : '—'} ${willReach ? `<div class="sub muted">(ETA ${etaArr})</div>` : ''} ${arrAfterMidnight}</td>
      <td data-label="Status">${status}</td>
      <td data-label="Notes">${note}</td>
    `;
    tbody.appendChild(tr);
  });

  tblCard.appendChild(table);
  document.getElementById('results').appendChild(tblCard);
}

function renderDebug(all, debug, origin, dest){
  try {
    const total = all.length;
    const valid = all.filter(x=>x.valid).length;
    const missingTimes = all.filter(x=>x.reason==="missing_time_for_stop").length;
    const routesMissingStops = debug.filter(x=>x.reason==="route_missing_one_of_stops").length;
    const details = [
      `Runs considered: ${total}`,
      `Valid direct runs: ${valid}`,
      `Runs missing one/both times: ${missingTimes}`,
      `Routes missing one of the stops: ${routesMissingStops}`
    ].join(" • ");
    const sample = all.slice(0,10).map(x => ({
      route: x.route, run: x.run, dep: x.dep, arr: x.arr, valid: !!x.valid
    }));
    return `<details class="debug"><summary>Why am I not seeing some routes?</summary>
      <div class="sub">${details}</div>
      <pre class="mono">${JSON.stringify({origin, dest, sample}, null, 2)}</pre>
    </details>`;
  } catch(e){
    return '';
  }
}

async function init(){
  document.getElementById('now').textContent = new Date().toLocaleString();
  const res = await fetch('schedule.json');
  STATE.data = await res.json();
  STATE.stops = uniqueStops(STATE.data);
  populateSelectors();

  const origin = document.getElementById('origin');
  const destination = document.getElementById('destination');
  const routeFilter = document.getElementById('routeFilter');
  const btn = document.getElementById('findBtn');

  function validate(){ btn.disabled = !(origin.value && destination.value && origin.value !== destination.value); }
  origin.addEventListener('change', validate);
  destination.addEventListener('change', validate);
  btn.addEventListener('click', () => { renderDirect(origin.value, destination.value, routeFilter.value || null); });
}

init();
</script>
</body>
</html>
