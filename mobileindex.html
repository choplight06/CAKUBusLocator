<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Bus Finder</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #666666;
      --border: #e6e6e6;
      --ok-bg: #eaf8ef;
      --ok-br: #bfe8cc;
      --no-bg: #fbeeee;
      --no-br: #f3c0c0;
      --accent: #0f172a;
      --card-shadow: 0 2px 8px rgba(0,0,0,.06);
      --radius: 16px;
      --sp: 16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color-scheme: light dark;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b0b0b;
        --fg: #f1f5f9;
        --muted: #a3a3a3;
        --border: #262626;
        --ok-bg: #0f2618;
        --ok-br: #214731;
        --no-bg: #2a1111;
        --no-br: #5d2a2a;
        --accent: #93c5fd;
        --card-shadow: 0 1px 6px rgba(0,0,0,.4);
      }
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      padding-bottom: 72px; /* room for FAB */
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 20px clamp(12px, 3vw, 28px);
    }
    h1, h2, h3 {
      margin: .3em 0;
      line-height: 1.2;
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    h1 { font-size: clamp(1.4rem, 2.5vw, 2rem); }
    h2 { font-size: clamp(1.2rem, 2vw, 1.5rem); }
    h3 { font-size: clamp(1.05rem, 1.8vw, 1.25rem); }

    /* Cards */
    .card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: clamp(12px, 2vw, 18px);
      box-shadow: var(--card-shadow);
      background: var(--bg);
      margin-bottom: 16px;
    }

    /* Sticky query bar */
    .sticky {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(6px);
      background: color-mix(in srgb, var(--bg) 85%, transparent);
      border: 1px solid var(--border);
    }

    /* Form layout */
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 700px) {
      .row { grid-template-columns: 1fr; }
    }
    label {
      font-size: .9rem;
      color: var(--muted);
      margin-bottom: 6px;
      display: block;
    }
    select, button {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 14px 14px;
      font-size: 1rem;
      background: var(--bg);
      color: var(--fg);
      -webkit-tap-highlight-color: transparent;
    }
    select:focus, button:focus {
      outline: 3px solid rgba(100, 149, 237, .4);
      outline-offset: 2px;
    }
    button {
      border-color: var(--accent);
      background: var(--accent);
      color: white;
      font-weight: 600;
      transition: transform .06s ease, opacity .2s ease;
    }
    button:active { transform: translateY(1px) scale(0.99); }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      align-items: end;
    }
    @media (max-width: 700px) {
      .grid-3 { grid-template-columns: 1fr; }
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: .8rem;
      border: 1px solid var(--border);
    }
    .ok { background: var(--ok-bg); border-color: var(--ok-br); }
    .no { background: var(--no-bg); border-color: var(--no-br); }
    .muted { color: var(--muted); }
    .sub { font-size: .9rem; color: var(--muted); }

    /* Table (desktop) */
    table { width: 100%; border-collapse: collapse; }
    th, td { border-top: 1px solid var(--border); padding: 10px; text-align: left; vertical-align: top; }
    thead th { position: sticky; top: 0; background: var(--bg); }
    .scroll-x { overflow-x: auto; }

    /* Table -> Cards (mobile) */
    @media (max-width: 700px) {
      .table-as-cards table, .table-as-cards thead, .table-as-cards tbody, .table-as-cards th, .table-as-cards td, .table-as-cards tr {
        display: block;
        width: 100%;
      }
      .table-as-cards thead { display: none; }
      .table-as-cards tr {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px;
        margin-bottom: 10px;
      }
      .table-as-cards td {
        border: 0;
        padding: 6px 0;
      }
      .table-as-cards td::before {
        content: attr(data-label);
        font-weight: 600;
        display: block;
        color: var(--muted);
        margin-bottom: 2px;
      }
    }

    /* Floating action button */
    .fab {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 60;
      border-radius: 999px;
      padding: 14px 18px;
      background: var(--accent);
      color: #fff;
      border: none;
      box-shadow: var(--card-shadow);
      font-size: 1rem;
    }
    .fab:active { transform: translateY(1px) scale(0.98); }

    /* Safe-area on iOS */
    .fab { bottom: max(16px, env(safe-area-inset-bottom)); right: max(16px, env(safe-area-inset-right)); }
    .container { padding-bottom: calc(20px + env(safe-area-inset-bottom)); }
  </style>
</head>
<body>
  <div class="container">
    <h1>Find Your Next Bus</h1>

    <div id="queryCard" class="card sticky">
      <div class="row">
        <div>
          <label for="origin">You're at</label>
          <select id="origin" aria-label="Select origin stop"></select>
        </div>
        <div>
          <label for="destination">You're going to</label>
          <select id="destination" aria-label="Select destination stop"></select>
        </div>
      </div>
      <div style="margin-top:12px" class="grid-3">
        <div>
          <label>Current time (local)</label>
          <div id="now" class="sub"></div>
        </div>
        <div>
          <label for="routeFilter">Route filter (optional)</label>
          <select id="routeFilter" aria-label="Filter by route"></select>
        </div>
        <div>
          <button id="findBtn" disabled>Find buses</button>
        </div>
      </div>
    </div>

    <div id="results"></div>
  </div>

  <button class="fab" id="toTopBtn" title="Change stops">Change stops ↑</button>

<script>
const STATE = { data: null, stops: [], routes: [] };

/* === UI Canonicalization to de-dup stops === */
function canonStop(raw){
  if (!raw) return raw;
  let s = String(raw).trim();
  const low = s.toLowerCase().replace(/\s+/g,' ').trim();
  const map = new Map([
    ["class vii yard","Class VII"],
    ["class vii","Class VII"],
    ["wash rack","Washrack"],
    ["washrack","Washrack"],
    ["zone 6 dfac","DFAC 6"],
    ["zone 6 dfac, dfac 6","DFAC 6"],
    ["dfac 6","DFAC 6"],
    ["paint shop","Paint Shop"],
    ["paintshop","Paint Shop"],
    ["zone 2 dfac","DFAC 2"],
    ["dfac 2","DFAC 2"],
  ]);
  if (map.has(low)) return map.get(low);
  const m1 = low.match(/^zone\s+(\d+)\s+dfac$/);
  if (m1) return `DFAC ${m1[1]}`;
  const m2 = low.match(/^dfac\s*([0-9]+)$/);
  if (m2) return `DFAC ${m2[1]}`;
  const tokens = s.split(/\s+/).map(t => {
    const upper = t.toUpperCase();
    if (["BLDG","DFAC","MP","HHC","TMC","PBO","AWRDS","CFCC"].includes(upper)) return upper;
    if (upper==="VII") return "VII";
    return t.charAt(0).toUpperCase()+t.slice(1).toLowerCase();
  });
  let canon = tokens.join(" ");
  if (canon.toUpperCase()==="WASHRACK") canon = "Washrack";
  if (canon.toUpperCase()==="CLASS VII") canon = "Class VII";
  return canon;
}

/* === Time helpers === */
function pad(n){ return String(n).padStart(2,'0'); }
function toMinutes(hhmm){ const [h,m] = hhmm.split(':').map(x=>parseInt(x,10)); return h*60+m; }
function fmtETA(minDiff){
  if (minDiff < 0) return "departed";
  const h = Math.floor(minDiff/60); const m = minDiff%60;
  return h===0 ? `${m} min` : `${h} hr ${m} min`;
}
function localNowHHMM(){ const d = new Date(); return pad(d.getHours())+":"+pad(d.getMinutes()); }
function normalizeNextTimePair(dep, arr, nowMin){
  let depMin = toMinutes(dep); let arrMin = toMinutes(arr);
  if (depMin < nowMin) depMin += 1440;
  if (arrMin <= toMinutes(dep)) arrMin += 1440;
  if (arrMin < depMin) arrMin = depMin + 1;
  return {depMin, arrMin};
}
function projectAfter(baseMin, clockHHMM){
  let t = toMinutes(clockHHMM); while (t < baseMin) t += 1440; return t;
}

/* === Stops & selectors === */
function uniqueStops(data){
  const set = new Set();
  data.routes.forEach(r => r.stops.forEach(st => set.add(canonStop(st))));
  return Array.from(set).sort((a,b)=>a.localeCompare(b));
}
function populateSelectors(){
  const origin = document.getElementById('origin');
  const destination = document.getElementById('destination');
  const routeFilter = document.getElementById('routeFilter');
  const stops = STATE.stops;
  origin.innerHTML = `<option value="">Select stop…</option>` + stops.map(s=>`<option>${s}</option>`).join('');
  destination.innerHTML = `<option value="">Select stop…</option>` + stops.map(s=>`<option>${s}</option>`).join('');
  const routes = STATE.data.routes.map(r=>r.route_name);
  routeFilter.innerHTML = `<option value="">All routes</option>` + routes.map(r=>`<option>${r}</option>`).join('');
}

/* === Mapping & searches === */
function mapRunTimesByStop(run){
  const m = new Map();
  run.times.forEach(t => m.set(canonStop(t.stop), t.time));
  return m;
}
function findDirectRuns(origin, dest, routeNameOpt){
  const now = localNowHHMM();
  const nowMin = toMinutes(now);
  const all = [];
  STATE.data.routes.forEach(route => {
    if (routeNameOpt && route.route_name !== routeNameOpt) return;
    const stopsCanon = route.stops.map(canonStop);
    const idxMap = new Map(stopsCanon.map((s,i)=>[s,i]));
    if (!idxMap.has(origin) || !idxMap.has(dest)) return;
    const iO = idxMap.get(origin), iD = idxMap.get(dest);
    if (iD <= iO) return; // direct only
    route.runs.forEach(run => {
      const timeMap = mapRunTimesByStop(run);
      const tO = timeMap.get(origin);
      const tD = timeMap.get(dest);
      if (!tO || !tD) {
        all.push({route: route.route_name, run: run.bus_id, dep: null, arr: null, valid:false});
        return;
      }
      const pair = normalizeNextTimePair(tO, tD, nowMin);
      const valid = pair.arrMin > pair.depMin;
      all.push({ route: route.route_name, run: run.bus_id, dep: tO, arr: tD, depMin: pair.depMin, arrMin: pair.arrMin, valid });
    });
  });
  const candidates = all.filter(x=>x.valid);
  candidates.sort((a,b)=> a.arrMin - b.arrMin || a.depMin - b.depMin);
  const recommended = candidates[0] || null;
  const others = all
    .filter(x=>!recommended || x.run !== recommended.run || x.route !== recommended.route)
    .filter(x=>x.dep)
    .sort((a,b)=> (a.depMin || 1e9) - (b.depMin || 1e9));
  return {recommended, others, nowMin};
}
function findBestTransfer(origin, dest){
  const nowMin = toMinutes(localNowHHMM());
  let best = null;
  const routeIdx = STATE.data.routes.map(r => ({
    route: r,
    stopsCanon: r.stops.map(canonStop),
  }));
  const allStops = new Set();
  routeIdx.forEach(({stopsCanon}) => stopsCanon.forEach(s => allStops.add(s)));
  const stopsList = Array.from(allStops).filter(s => s !== origin && s !== dest);

  function bestLeg(originStop, endStop, notBeforeMin){
    let bestLeg = null;
    routeIdx.forEach(({route, stopsCanon})=>{
      const idx = new Map(stopsCanon.map((s,i)=>[s,i]));
      if (!idx.has(originStop) || !idx.has(endStop)) return;
      const iO = idx.get(originStop), iE = idx.get(endStop);
      if (iE <= iO) return;
      route.runs.forEach(run => {
        const times = mapRunTimesByStop(run);
        const tO = times.get(originStop);
        const tE = times.get(endStop);
        if (!tO || !tE) return;
        let depMin = projectAfter(notBeforeMin, tO);
        let arrMin = projectAfter(depMin, tE);
        if (arrMin <= depMin) arrMin += 1440;
        const leg = { route: route.route_name, run: run.bus_id, dep: tO, arr: tE, depMin, arrMin };
        if (!bestLeg || leg.arrMin < bestLeg.arrMin || (leg.arrMin === bestLeg.arrMin && leg.depMin < bestLeg.depMin)){
          bestLeg = leg;
        }
      });
    });
    return bestLeg;
  }

  for (const via of stopsList){
    const leg1 = bestLeg(origin, via, nowMin);
    if (!leg1) continue;
    const leg2 = bestLeg(via, dest, leg1.arrMin);
    if (!leg2) continue;
    const totalArrMin = leg2.arrMin;
    if (!best || totalArrMin < best.totalArrMin){
      best = { via, leg1, leg2, totalArrMin };
    }
  }
  return best;
}

/* === Rendering === */
function renderDirect(origin, dest, routeOpt){
  const {recommended, others, nowMin} = findDirectRuns(origin, dest, routeOpt);
  const container = document.getElementById('results');
  container.innerHTML = '';

  if (!recommended){
    const transfer = findBestTransfer(origin, dest);
    if (!transfer){
      container.innerHTML = `<div class="card"><h3>No direct routes found</h3>
        <div class="muted">There are also no single-transfer options at this time.</div></div>`;
      return;
    }
    const totalETA = fmtETA(transfer.totalArrMin - nowMin);
    const leg1Wait = fmtETA(transfer.leg1.depMin - nowMin);
    const leg2Wait = fmtETA(transfer.leg2.depMin - transfer.leg1.arrMin);
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h3>No direct routes available</h3>
      <div>However, you can <b>opt for a transfer</b> at <b>${transfer.via}</b>:</div>
      <ol>
        <li>Leg 1 — <span class="pill">${transfer.leg1.route}</span> <span class="pill">${transfer.leg1.run}</span><br/>
          Depart <b>${origin}</b> at <b>${transfer.leg1.dep}</b> (in ${leg1Wait}), arrive <b>${transfer.via}</b> at <b>${transfer.leg1.arr}</b>.
        </li>
        <li>Transfer wait at <b>${transfer.via}</b>: ${leg2Wait}</li>
        <li>Leg 2 — <span class="pill">${transfer.leg2.route}</span> <span class="pill">${transfer.leg2.run}</span><br/>
          Depart <b>${transfer.via}</b> at <b>${transfer.leg2.dep}</b>, arrive <b>${dest}</b> at <b>${transfer.leg2.arr}</b> (ETA ${totalETA}).
        </li>
      </ol>
    `;
    container.appendChild(card);
    return;
  }

  const earlierArrival = others.filter(o => o.valid && typeof o.arrMin==='number' && o.arrMin < recommended.arrMin);

  const rec = document.createElement('div');
  rec.className = 'card';
  const depIn = fmtETA(recommended.depMin - nowMin);
  const arrIn = fmtETA(recommended.arrMin - nowMin);
  rec.innerHTML = `
    <h3>Next bus to get you there</h3>
    <div><span class="pill">${recommended.route}</span> <span class="pill">${recommended.run}</span></div>
    <div class="sub" style="margin-top:8px">
      Departs <b>${origin}</b> at <b>${recommended.dep}</b> (in ${depIn}), arrives <b>${dest}</b> at <b>${recommended.arr}</b> (ETA ${arrIn}).
      ${recommended.arrMin >= 1440 ? `<div class="sub muted">* arrives after midnight</div>` : ''}
    </div>
    ${earlierArrival.length ? `<div class="note" style="margin-top:6px">Note: a later bus will arrive earlier than this one. See list below.</div>` : ''}
  `;
  container.appendChild(rec);

  const tblCard = document.createElement('div');
  tblCard.className = 'card scroll-x table-as-cards';
  tblCard.innerHTML = `<h3>Other upcoming buses from ${origin}</h3>`;
  const table = document.createElement('table');
  table.innerHTML = `
    <thead>
      <tr><th>Route / Run</th><th>Departs</th><th>Arrives at ${dest}</th><th>Status</th><th>Notes</th></tr>
    </thead>
    <tbody></tbody>
  `;
  const tbody = table.querySelector('tbody');

  others.forEach(o => {
    const willReach = o.valid;
    const etaDep = fmtETA((o.depMin ?? 1e9) - nowMin);
    const etaArr = willReach ? fmtETA((o.arrMin ?? 1e9) - nowMin) : '—';
    const status = willReach ? `<span class="pill ok">will reach your destination</span>`
                             : `<span class="pill no">will not</span>`;
    const note = (willReach && o.arrMin < recommended.arrMin) ? `this bus will also take you to your destination` : '';
    const arrAfterMidnight = willReach && o.arrMin >= 1440 ? `<div class="sub muted">* arrives after midnight</div>` : '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td data-label="Route / Run"><div><b>${o.route}</b></div><div class="sub">${o.run}</div></td>
      <td data-label="Departs">${o.dep} <div class="sub muted">(${etaDep})</div></td>
      <td data-label="Arrives">${willReach ? o.arr : '—'} ${willReach ? `<div class="sub muted">(ETA ${etaArr})</div>` : ''} ${arrAfterMidnight}</td>
      <td data-label="Status">${status}</td>
      <td data-label="Notes">${note}</td>
    `;
    tbody.appendChild(tr);
  });

  tblCard.appendChild(table);
  document.getElementById('results').appendChild(tblCard);
}

/* === Init === */
async function init(){
  document.getElementById('now').textContent = new Date().toLocaleString();
  const res = await fetch('schedule.json');
  STATE.data = await res.json();
  STATE.stops = uniqueStops(STATE.data);
  populateSelectors();

  const origin = document.getElementById('origin');
  const destination = document.getElementById('destination');
  const routeFilter = document.getElementById('routeFilter');
  const btn = document.getElementById('findBtn');
  const toTop = document.getElementById('toTopBtn');
  const queryCard = document.getElementById('queryCard');

  function validate(){ btn.disabled = !(origin.value && destination.value && origin.value !== destination.value); }
  origin.addEventListener('change', validate);
  destination.addEventListener('change', validate);
  btn.addEventListener('click', () => { renderDirect(origin.value, destination.value, routeFilter.value || null); });
  toTop.addEventListener('click', () => { queryCard.scrollIntoView({behavior: 'smooth', block: 'start'}); });
}

init();
</script>
</body>
</html>
